{% extends "base.html" %}
{% block title %}Notes{% endblock title %}
{% block css %}
    <style>
        /* Import Google Font - Poppins */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        .color{
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
        }
        *{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
        }
        ::selection{
        color: #fff;
        background: #618cf8;
        }
        .notes-container{
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        }
        .notes-container li{
        height: 250px;
        list-style: none;
        border-radius: 5px;
        padding: 15px 20px 20px;
        background: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .add-box, .icon, .bottom-content, 
        .popup, header, .settings .menu li{
        display: flex;
        align-items: center;
        justify-content: space-between;
        }
        .add-box{
        cursor: pointer;
        flex-direction: column;
        justify-content: center;
        }
        .add-box .icon{
        height: 78px;
        width: 78px;
        color: #88ABFF;
        font-size: 40px;
        border-radius: 50%;
        justify-content: center;
        border: 2px dashed #88ABFF;
        }
        .search-input .icon{
            background-color: #88ABFF;
            font-size: 40px;
            justify-content: center;
            color: #fff;
            border-radius: 0 4px 4px 0;
        }
        .add-box p{
        color: #88ABFF;
        font-weight: 500;
        margin-top: 20px;
        }
        .note{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        cursor: pointer;
        }
        .note .details{
        max-height: 165px;
        overflow-y: auto;
        }
        .note .details::-webkit-scrollbar,
        .popup textarea::-webkit-scrollbar{
        width: 0;
        }
        .note .details:hover::-webkit-scrollbar,
        .popup textarea:hover::-webkit-scrollbar{
        width: 5px;
        }
        .note .details:hover::-webkit-scrollbar-track,
        .popup textarea:hover::-webkit-scrollbar-track{
        background: #f1f1f1;
        border-radius: 25px;
        }
        .note .details:hover::-webkit-scrollbar-thumb,
        .popup textarea:hover::-webkit-scrollbar-thumb{
        background: #e6e6e6;
        border-radius: 25px;
        }
        .note p{
        font-size: 22px;
        font-weight: 500;
        }
        .note span{
        display: block;
        color: #444;
        font-size: 16px;
        margin-top: 5px;
        }
        .note .bottom-content{
        padding-top: 10px;
        border-top: 1px solid #ccc;
        }
        .bottom-content span{
        color: #6D6D6D;
        font-size: 14px;
        }
        .bottom-content .settings{
        position: relative;
        }
        .bottom-content .settings i{
        color: #6D6D6D;
        cursor: pointer;
        font-size: 15px;
        }
        .settings .menu{
        z-index: 1;
        bottom: 0;
        right: -5px;
        padding: 5px 0;
        background: #fff;
        position: absolute;
        border-radius: 4px;
        transform: scale(0);
        transform-origin: bottom right;
        box-shadow: 0 0 6px rgba(0,0,0,0.15);
        transition: transform 0.2s ease;
        }
        .settings.show .menu{
        transform: scale(1);
        }
        .settings .menu li{
        height: 25px;
        font-size: 16px;
        margin-bottom: 2px;
        padding: 17px 15px;
        cursor: pointer;
        box-shadow: none;
        border-radius: 0;
        justify-content: flex-start;
        }
        .menu li:last-child{
        margin-bottom: 0;
        }
        .menu li:hover{
        background: #f5f5f5;
        }
        .menu li i{
        padding-right: 8px;
        }

        .popup-box{
        position: fixed;
        top: 0;
        left: 0;
        z-index: 2;
        height: 100%;
        width: 100%;
        background: rgba(0,0,0,0.4);
        }
        .popup-box .popup{
        position: absolute;
        top: 50%;
        left: 50%;
        z-index: 3;
        justify-content: center;
        transform: translate(-50%, -50%) scale(0.90);
        }
        .popup-box, .popup{
        opacity: 0;
        pointer-events: none;
        transition: all 0.25s ease;
        }
        .popup-box.show, .popup-box.show .popup{
        opacity: 1;
        pointer-events: auto;
        }
        .popup-box.show .popup{
        transform: translate(-50%, -50%) scale(1);
        }
        .popup .content{
        border-radius: 5px;
        background: #fff;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .content header{
        padding: 15px;
        border-bottom: 1px solid #ccc;
        }
        .content header p{
        font-size: 2rem;
        font-weight: 500;
        }
        .content header i{
        color: #8b8989;
        cursor: pointer;
        font-size: 2rem;
        }
     
        form :where(input, textarea){
        outline: none;
        font-size: 17px;
        padding: 0 15px;
        border-radius: 4px;
        border: 1px solid #999;
        }
        form :where(input, textarea):focus{
        box-shadow: 0 2px 4px rgba(0,0,0,0.11);
        }
        form textarea{
        height: 400px;
        resize: none;
        padding: 8px 15px;
        }
        form button{
        height: 50px;
        color: #fff;
        outline: none;
        border: none;
        cursor: pointer;
        font-size: 17px;
        border-radius: 4px;
        background: #6A93F8;
        }
        .cl-1 {
            background-color: #CBF0F8 !important;
        }
        .cl-2 {
            background-color: #F28B82 !important;
        }
    </style>        
    <style>
        .checkbox-wrapper-30 .checkbox {
            --brdr: #555;
            --brdr-actv: #555;
            --brdr-hovr: #bbc1e1;
            --dur: calc((var(--size, 2)/2) * 0.6s);
            display: inline-block;
            width: calc(var(--size, 1) * 22px);
            position: relative;
        }
        .checkbox-wrapper-30 .checkbox:after {
            content: "";
            width: 100%;
            padding-top: 100%;
            display: block;
        }
        .checkbox-wrapper-30 .checkbox > * {
            position: absolute;
        }
        .checkbox-wrapper-30 .checkbox input {
            -webkit-appearance: none;
            -moz-appearance: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
            background-color: var(--bg);
            border-radius: calc(var(--size, 1) * 4px);
            border: calc(var(--newBrdr, var(--size, 1)) * 1px) solid;
            color: var(--newBrdrClr, var(--brdr));
            outline: none;
            margin: 0;
            padding: 0;
            transition: all calc(var(--dur) / 3) linear;
        }
        .checkbox-wrapper-30 .checkbox input:hover,
        .checkbox-wrapper-30 .checkbox input:checked {
            --newBrdr: calc(var(--size, 1) * 2);
        }
        .checkbox-wrapper-30 .checkbox input:hover {
            --newBrdrClr: var(--brdr-hovr);
        }
        .checkbox-wrapper-30 .checkbox input:checked {
            --newBrdrClr: var(--brdr-actv);
            transition-delay: calc(var(--dur) /1.3);
        }
        .checkbox-wrapper-30 .checkbox input:checked + svg {
            --dashArray: 16 93;
            --dashOffset: 109;
        }
        .checkbox-wrapper-30 .checkbox svg {
            fill: #fff;
            left: 0;
            pointer-events: none;
            stroke: var(--stroke, var(--border-active));
            stroke-dasharray: var(--dashArray, 93);
            stroke-dashoffset: var(--dashOffset, 94);
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-width: 2px;
            top: 0;
            transition: stroke-dasharray var(--dur), stroke-dashoffset var(--dur);
        }
        .checkbox-wrapper-30 .checkbox svg,
        .checkbox-wrapper-30 .checkbox input {
            display: block;
            height: 100%;
            width: 100%;
        }
    </style>          
{% endblock css %}
{% block body %}
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="checkbox-light" viewBox="0 0 22 22">
            <path fill="none" stroke="#ffffff" d="M5.5,11.3L9,14.8L20.2,3.3l0,0c-0.5-1-1.5-1.8-2.7-1.8h-13c-1.7,0-3,1.3-3,3v13c0,1.7,1.3,3,3,3h13 c1.7,0,3-1.3,3-3v-13c0-0.4-0.1-0.8-0.3-1.2"/>
        </symbol>
        <symbol id="checkbox-dark" viewBox="0 0 22 22">
            <path fill="none" stroke="currentColor" d="M5.5,11.3L9,14.8L20.2,3.3l0,0c-0.5-1-1.5-1.8-2.7-1.8h-13c-1.7,0-3,1.3-3,3v13c0,1.7,1.3,3,3,3h13 c1.7,0,3-1.3,3-3v-13c0-0.4-0.1-0.8-0.3-1.2"/>
        </symbol>
    </svg>

    <div class="ts-circle bg-white bg-opacity-75 shadow">
        <a href="/accounts/profile/" style="color:#88ABFF"><i class="fa-solid fa-arrow-left"></i></a>
    </div>

    <div class="popup-box">
      <div class="popup col-10 col-md-7">
        <div class="content col-12">
          <header>
            <input class="form-control" type="text" spellcheck="false" placeholder="Title...">
            <i class="ti ti-x"></i>
          </header>
          <form action="#" class="m-3">
            <div class="title mb-3">
              <!--label>Title</label-->
            </div>
            <div class="description mb-3">
              <!--label>Description</label-->
              <textarea class="form-control" spellcheck="false" placeholder="Note Description..."></textarea>
            </div>
            <div class="d-flex align-items-center gap-3 border border-3 p-3 rounded mb-3">
                Note color:
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-white" checked/>
                        <svg>
                        <use xlink:href="#checkbox-dark" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-primary"/>
                        <svg>
                        <use xlink:href="#checkbox-light" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-success"/>
                        <svg>
                        <use xlink:href="#checkbox-light" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-warning"/>
                        <svg>
                        <use xlink:href="#checkbox-light" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-info"/>
                        <svg>
                        <use xlink:href="#checkbox-light" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
                <div class="checkbox-wrapper-30">
                    <span class="checkbox">
                        <input type="checkbox" class="bg-danger"/>
                        <svg>
                        <use xlink:href="#checkbox-light" class="checkbox"></use>
                        </svg>
                    </span>
                </div>
            </div>
            <button class="col-10 me-2"></button><button class="btn btn-danger col-auto fs-3"><i class="ti ti-trash"></i></button>
          </form>
        </div>
      </div>
    </div>

    <!-- search -->
    <div class="container my-4">
        <div class="wrapper col-10 col-md-8">
            <div class="search-input">
                <input type="text" class="form-control" placeholder="Type to search..." autocomplete="off"/>
                <a onclick="addBox.click()"><div class="icon rounded"><i class="ti ti-plus icon"></i></div></a>
            </div>
        </div>
    </div>

    <div class="notes-container m-5">
      <li class="add-box">
        <div class="icon"><i class="ti ti-plus"></i></div>
        <p>Add new note</p>
      </li>
    </div>
</div>

    <script>
        const searchWrapper = document.querySelector(".search-input");
        const inputBox = searchWrapper.querySelector("input");
        
        const addBox = document.querySelector(".add-box"),
        popup = document.querySelector(".popup"),
        notes_c = document.querySelector(".notes-container"),
        popupBox = document.querySelector(".popup-box"),
        //popupTitle = popupBox.querySelector("header p"),
        closeIcon = popupBox.querySelector("header i"),
        titleTag = popupBox.querySelector("input"),
        descTag = popupBox.querySelector("textarea"),
        addBtn = popupBox.querySelector("button");
        var color = "bg-white";

        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const notes = JSON.parse("{{notes|escapejs}}" || "[]"); //JSON.parse(localStorage.getItem("notes") || "[]");
        let isUpdate = false, updateId;

        $(".checkbox-wrapper-30").on("click", (e) => {
            let clr_elems = document.getElementsByClassName("checkbox-wrapper-30");
            for (let x of clr_elems){
                let checkb = x.querySelector("input");
                checkb.checked = false;
            };
            e.target.checked = true;
            color = e.target.getAttribute("class");
            //console.log(e.target.id);
        });

        addBox.addEventListener("click", () => {
            //popupTitle.innerText = "Add a new Note";
            addBtn.innerText = "Add Note";
            popupBox.classList.add("show");
            document.querySelector("body").style.overflow = "hidden";
            if(window.innerWidth > 660) titleTag.focus();
        });

        popupBox.addEventListener("click", (e) => {
            if(e.target == popupBox){
                addBtn.click();
                popupBox.classList.remove("show");
                document.querySelector("body").style.overflow = "auto";
            }
        });

        closeIcon.addEventListener("click", () => {
            isUpdate = false;
            titleTag.value = descTag.value = "";
            popupBox.classList.remove("show");
            document.querySelector("body").style.overflow = "auto";
        });

        function showNotes(notes) {
            if(!notes) return;
            document.querySelectorAll(".note").forEach(li => li.remove());
            notes.forEach((note, id) => {
                let filterDesc = note.note.replaceAll("\n", '<br/>');
                let liTag = `<li class="note col-12 col-md-3 animate__animated animate__fadeIn ${note.color} bg-opacity-50" style="animation-delay: 0.${id+3}s;">
                                <div class="details" onclick="updateNote(${id})">
                                    <p>${note.title}</p>
                                    <span>${filterDesc}</span>
                                </div>
                                <div class="bottom-content">
                                    <span>${note.created}</span>
                                    <div class="settings">
                                        <i onclick="showMenu(this)" class="ti ti-dots"></i>
                                        <ul class="menu">
                                            <li onclick="updateNote(${id})"><i class="ti ti-pencil"></i>Edit</li>
                                            <li onclick="deleteNote(${id})"><i class="ti ti-trash"></i>Delete</li>
                                        </ul>
                                    </div>
                                </div>
                            </li>`;
                notes_c.insertAdjacentHTML("beforeend", liTag);
            });
        }
        showNotes(notes);

        inputBox.onkeyup = (e)=>{
            let userData = e.target.value; //user enetered data
            let emptyArray = [];
            if(userData){
                emptyArray = notes.filter((data)=>{
                    //filtering array value and user characters to lowercase and return only those words which are start with user enetered chars
                    return data.title.replace(/[^a-zA-Z0-9 ]/g,'').toLocaleLowerCase().includes(userData.toLocaleLowerCase()) || data.note.replace(/[^a-zA-Z0-9 ]/g,'').toLocaleLowerCase().includes(userData.toLocaleLowerCase());
                });
                showNotes(emptyArray);
            } else {
                showNotes(notes);
            }
        }

        function showMenu(elem) {
            elem.parentElement.classList.add("show");
            document.addEventListener("click", e => {
                if(e.target.tagName != "I" || e.target != elem) {
                    elem.parentElement.classList.remove("show");
                }
            });
        }

        function deleteNote(noteId) {
            let confirmDel = confirm("Are you sure you want to delete this note?");
            if(!confirmDel) return;
            notes.splice(noteId, 1);
        }

        function updateNote(id) {
            updateId = notes[id].pk;
            isUpdate = true;
            addBox.click();
            titleTag.value = notes[id].title;
            descTag.value = notes[id].note;
            color = notes[id].color;
            //popupTitle.innerText = "Update a Note";
            addBtn.innerText = "Update Note";

            let clr_elems = document.getElementsByClassName("checkbox-wrapper-30");
            for (let x of clr_elems){
                let checkb = x.querySelector("input");
                if (checkb.getAttribute("class") == color) checkb.click();
            };
        }

        addBtn.addEventListener("click", e => {
            e.preventDefault();
            let title = titleTag.value.trim(),
            description = descTag.value.trim();

            if(title || description) {
                let currentDate = new Date(),
                month = currentDate.getMonth(),
                day = currentDate.getDate(),
                year = currentDate.getFullYear();

                let noteInfo = [`${month}-${day}-${year}`,title, description, color];
                if(!isUpdate) {
                    addNote({date:noteInfo[0],title,description,color},"add",0);
                } else {
                    addNote({date:noteInfo[0],title,description,color},"update",updateId);
                    isUpdate = false;
                }
                closeIcon.click();
            }
        });

        function addNote(){
            let vars = arguments;
            let xhttp = new XMLHttpRequest();
            xhttp.onload = () => {
                window.location.reload();
            }
            xhttp.open("POST","{% url 'notes' %}", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // required with POST request
            //xhttp.send(); // required with GET request
            xhttp.send("csrfmiddlewaretoken={{csrf_token}}&action="+vars[1]+"&note="+JSON.stringify(vars[0])+"&pk="+vars[2]);
        }
    </script>
{% endblock body %}